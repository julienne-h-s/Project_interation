name: CI/CD Pipeline for Speech Commands Project

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:

  ####################################################################
  # 1) TRAINING JOB — ТРЕНУЄ МОДЕЛЬ У DOCKER CONTAINER
  ####################################################################
  train-model:
    name: Train Model in Docker
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Training Image
      run: |
        docker build -t speech-trainer -f Dockerfile.multistage --target trainer .

    - name: Run Training Container
      run: |
        docker run --rm -v ${{ github.workspace }}:/app speech-trainer

    - name: Upload trained model as artifact
      uses: actions/upload-artifact@v3
      with:
        name: trained-model
        path: saved_model.pth


  ####################################################################
  # 2) TEST-MODEL JOB — ПЕРЕВІРЯЄ ЯК ПРАЦЮЄ МОДЕЛЬ
  ####################################################################
  test-model:
    name: Validate Trained Model
    runs-on: ubuntu-latest
    needs: train-model

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download trained model
      uses: actions/download-artifact@v3
      with:
        name: trained-model

    - name: Run inference test
      run: |
        echo "import torch; print('Loading model...'); \
        model=torch.load('saved_model.pth', map_location='cpu'); print('OK')" \
        > test_script.py

        python3 test_script.py

    - name: Save test log
      uses: actions/upload-artifact@v3
      with:
        name: inference-test-log
        path: test_script.py


  ####################################################################
  # 3) BUILD & PUSH INFERENCE IMAGE TO GHCR
  ####################################################################
  build-and-push:
    name: Build & Push Inference Docker Image
    runs-on: ubuntu-latest
    needs: [train-model, test-model]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download trained model
      uses: actions/download-artifact@v3
      with:
        name: trained-model

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Build inference image
      run: |
        docker build -t ghcr.io/${{ github.repository_owner }}/speech-api:latest \
          --target runtime -f Dockerfile.multistage .

    - name: Push inference image
      run: |
        docker push ghcr.io/${{ github.repository_owner }}/speech-api:latest

    - name: Upload image metadata
      uses: actions/upload-artifact@v3
      with:
        name: docker-image-info
        path: .
